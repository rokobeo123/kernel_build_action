name: ðŸ”‹ Xiaomi 14 Pro - AngelBeats + SukiSU + SUSFS

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Battery Profile'
        required: true
        default: 'balanced'
        type: choice
        options:
          - extreme_battery
          - balanced
          - performance
  
  push:
    branches:
      - main
    paths:
      - '.github/workflows/xiaomi14pro-angelbeats.yml'

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: Set profile
        run: |
          if [ -z "${{ inputs.profile }}" ]; then
            echo "PROFILE=balanced" >> $GITHUB_ENV
          else
            echo "PROFILE=${{ inputs.profile }}" >> $GITHUB_ENV
          fi
      
      - name: ðŸ§¹ Free space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
      
      - name: ðŸ“¦ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf imagemagick \
            lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev \
            libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop \
            pngcrush rsync schedtool squashfs-tools xsltproc zip \
            zlib1g-dev python3 python-is-python3 wget cpio kmod \
            libelf-dev libelf1 elfutils
      
      - name: ðŸ“‚ Clone kernel (shennong-u-oss - Android 14)
        run: |
          echo "ðŸ“¥ Cloning Xiaomi 14 Pro kernel..."
          git clone --depth=1 \
            https://github.com/MiCode/Xiaomi_Kernel_OpenSource \
            -b shennong-u-oss \
            kernel
          
          cd kernel
          echo "âœ… Kernel cloned!"
          make kernelversion 2>/dev/null || cat Makefile | head -5
      
      - name: ðŸ”§ Fix missing Kconfig
        working-directory: kernel
        run: |
          if [ -f "drivers/misc/Kconfig" ]; then
            sed -i '/source "drivers\/misc\/hwid\/Kconfig"/d' drivers/misc/Kconfig
          fi
      
      - name: ðŸ”§ Integrate SukiSU Ultra
        working-directory: kernel
        run: |
          echo "ðŸš€ Installing SukiSU with builtin SUSFS config..."
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
          
          if [ ! -d "KernelSU" ]; then
            echo "âŒ SukiSU integration failed!"
            exit 1
          fi
          
          echo "âœ… SukiSU integrated!"
      
      - name: ðŸ“¥ Clone SUSFS and copy 3 files exactly
        working-directory: kernel
        run: |
          echo "ðŸ“¥ Cloning SUSFS..."
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1
          
          echo ""
          echo "ðŸ“‹ SUSFS structure:"
          tree susfs4ksu/kernel_patches/ -L 3 2>/dev/null || find susfs4ksu/kernel_patches/ -type f
          
          echo ""
          echo "ðŸ“ Copying SUSFS files (exactly 3 files)..."
          
          cd susfs4ksu/kernel_patches
          
          # File 1: fs/susfs.c â†’ kernel/fs/susfs.c
          if [ -f "fs/susfs.c" ]; then
            echo "âœ… Copying: fs/susfs.c â†’ ../../fs/susfs.c"
            cp -v fs/susfs.c ../../fs/
          else
            echo "âŒ fs/susfs.c NOT FOUND!"
          fi
          
          # File 2: include/linux/susfs_def.h â†’ kernel/include/linux/susfs_def.h
          if [ -f "include/linux/susfs_def.h" ]; then
            echo "âœ… Copying: include/linux/susfs_def.h â†’ ../../include/linux/susfs_def.h"
            mkdir -p ../../include/linux
            cp -v include/linux/susfs_def.h ../../include/linux/
          else
            echo "âŒ include/linux/susfs_def.h NOT FOUND!"
          fi
          
          # File 3: include/linux/susfs.h â†’ kernel/include/linux/susfs.h
          if [ -f "include/linux/susfs.h" ]; then
            echo "âœ… Copying: include/linux/susfs.h â†’ ../../include/linux/susfs.h"
            mkdir -p ../../include/linux
            cp -v include/linux/susfs.h ../../include/linux/
          else
            echo "âŒ include/linux/susfs.h NOT FOUND!"
          fi
          
          cd ../..
          
          echo ""
          echo "âœ… SUSFS files copied!"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "       VERIFICATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo ""
          echo "File 1: fs/susfs.c"
          ls -lh fs/susfs.c 2>/dev/null && echo "  âœ… Found!" || echo "  âŒ Missing!"
          
          echo ""
          echo "File 2: include/linux/susfs_def.h"
          ls -lh include/linux/susfs_def.h 2>/dev/null && echo "  âœ… Found!" || echo "  âŒ Missing!"
          
          echo ""
          echo "File 3: include/linux/susfs.h"
          ls -lh include/linux/susfs.h 2>/dev/null && echo "  âœ… Found!" || echo "  âŒ Missing!"
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Check if all files exist
          if [ -f "fs/susfs.c" ] && [ -f "include/linux/susfs_def.h" ] && [ -f "include/linux/susfs.h" ]; then
            echo "âœ… All SUSFS files present!"
          else
            echo "âŒ Some SUSFS files missing!"
            exit 1
          fi
      
      - name: âš¡ Create AngelBeats battery configs
        working-directory: kernel
        run: |
          mkdir -p arch/arm64/configs/vendor
          
          cat > arch/arm64/configs/vendor/angelbeats_extreme_battery.config << 'END'
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KPM=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_CPU_FREQ_GOV_POWERSAVE=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_PM_WAKELOCKS_LIMIT=100
          CONFIG_ZRAM=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_WIREGUARD=y
          END
          
          cat > arch/arm64/configs/vendor/angelbeats_balanced.config << 'END'
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KPM=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_PM_WAKELOCKS_LIMIT=200
          CONFIG_ZRAM=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_WIREGUARD=y
          END
          
          cat > arch/arm64/configs/vendor/angelbeats_performance.config << 'END'
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KPM=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_PM_WAKELOCKS_LIMIT=500
          CONFIG_ZRAM=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_WIREGUARD=y
          END
          
          echo "âœ… Battery configs created!"
      
      - name: ðŸ”¨ Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
      
      - name: âš™ï¸ Merge configs
        working-directory: kernel
        run: |
          BATTERY_CONFIG="angelbeats_${PROFILE}.config"
          echo "Profile: $PROFILE"
          
          cat arch/arm64/configs/gki_defconfig \
              arch/arm64/configs/vendor/shennong_GKI.config \
              arch/arm64/configs/vendor/$BATTERY_CONFIG \
              > .config
          
          echo "âœ… Configs merged!"
      
      - name: ðŸ› ï¸ Fix compilation issues
        working-directory: kernel
        run: |
          scripts/config --disable CONFIG_WERROR
          scripts/config --disable CONFIG_CC_WERROR
          scripts/config --disable CONFIG_SCHED_CLUSTER
          scripts/config --enable CONFIG_OF
          scripts/config --enable CONFIG_OF_EARLY_FLATTREE
          scripts/config --enable CONFIG_OF_FLATTREE
      
      - name: ðŸ—ï¸ Build kernel
        working-directory: kernel
        run: |
          export PATH="$GITHUB_WORKSPACE/clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1
          
          echo "Compiler:"
          clang --version | head -1
          
          echo "Kernel version:"
          make kernelversion
          
          echo "Resolving config..."
          make olddefconfig 2>&1 || true
          
          echo ""
          echo "ðŸš€ Building with $(nproc) cores..."
          echo ""
          
          make -j$(nproc) \
            KCFLAGS="-Wno-error -Wno-implicit-function-declaration -Wno-sometimes-uninitialized" \
            2>&1 | tee ../build.log
          
          if [ -f arch/arm64/boot/Image.gz ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âœ… BUILD SUCCESSFUL! âœ…     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            ls -lh arch/arm64/boot/Image.gz
          else
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âŒ BUILD FAILED! âŒ         â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            tail -200 ../build.log
            grep -i "error:" ../build.log | tail -50
            exit 1
          fi
      
      - name: ðŸ“¦ Package AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          cd AnyKernel3
          cp ../kernel/arch/arm64/boot/Image.gz ./
          
          cat > anykernel.sh << 'AK'
          properties() { '
          kernel.string=AngelBeats-SukiSU-SUSFS-Xiaomi14Pro
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          device.name1=shennong
          device.name2=Xiaomi 14 Pro
          device.name3=2311DRN47C
          supported.versions=14-15
          '; }
          block=/dev/block/by-name/boot;
          is_slot_device=auto;
          ramdisk_compression=auto;
          . tools/ak3-core.sh;
          dump_boot;
          write_boot;
          AK
          
          DATE=$(date +%Y%m%d-%H%M)
          ZIPNAME="AngelBeats-SukiSU-SUSFS-Xiaomi14Pro-${PROFILE}-${DATE}.zip"
          
          zip -r9 "../${ZIPNAME}" * -x .git README.md *placeholder
          
          cd ..
          echo "ZIPNAME=${ZIPNAME}" >> $GITHUB_ENV
          
          cat > KERNEL_INFO.txt << 'INFO'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  ðŸ”‹ AngelBeats-Style Kernel          â•‘
          â•‘  ðŸ“± Xiaomi 14 Pro (shennong)         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Features:
            â€¢ SukiSU Ultra (root solution)
            â€¢ SUSFS v2.0.0 (root hiding)
            â€¢ KPM + KProbes support
            â€¢ BBG (Baseband Guard)
            â€¢ AngelBeats battery optimization
            â€¢ BFQ I/O Scheduler
            â€¢ Schedutil CPU Governor
          
          ðŸ“¥ Installation:
            1. Backup boot.img
            2. Flash via TWRP
            3. Reboot
            4. Install KernelSU Manager
          
          ðŸ”‹ Enjoy better battery life!
          INFO
          
          echo "âœ… Packaged: ${ZIPNAME}"
      
      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Xiaomi-14-Pro-Kernel-${{ env.PROFILE }}
          path: |
            *.zip
            KERNEL_INFO.txt
            build.log
          retention-days: 30
      
      - name: ðŸŽ‰ Build complete!
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                       â•‘"
          echo "â•‘      âœ… BUILD SUCCESSFUL! âœ…         â•‘"
          echo "â•‘                                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“¦ Kernel: ${{ env.ZIPNAME }}"
          echo "âš¡ Profile: ${{ env.PROFILE }}"
          echo ""
          echo "ðŸ“¥ Download from Artifacts section!"
          echo "âš¡ Flash via TWRP and enjoy!"
          echo ""
