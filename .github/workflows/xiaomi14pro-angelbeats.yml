name: üîã Xiaomi 14 Pro - AngelBeats Style + SukiSU + SUSFS

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Battery Profile'
        required: true
        default: 'balanced'
        type: choice
        options:
          - extreme_battery
          - balanced
          - performance

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üßπ Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          df -h
      
      - name: üì¶ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf imagemagick \
            lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev \
            libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop \
            pngcrush rsync schedtool squashfs-tools xsltproc zip \
            zlib1g-dev python3 python-is-python3 wget cpio kmod
      
      - name: üìÇ Clone kernel source
        run: |
          git clone --depth=1 \
            https://github.com/MiCode/Xiaomi_Kernel_OpenSource \
            -b shennong-u-oss \
            kernel
          cd kernel
          make kernelversion 2>/dev/null || cat Makefile | grep "^VERSION\|^PATCHLEVEL\|^SUBLEVEL" | head -3
      
      - name: üîß Integrate SukiSU
        working-directory: kernel
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
          if [ -d "KernelSU" ]; then
            echo "‚úÖ SukiSU integrated!"
          else
            echo "‚ùå Failed!"
            exit 1
          fi
      
      - name: üì• Clone SUSFS
        working-directory: kernel
        run: |
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1
          
          # Copy SUSFS source files
          if [ -d "susfs4ksu/ksu_susfs" ]; then
            cp -v susfs4ksu/ksu_susfs/*.c KernelSU/kernel/ 2>/dev/null || true
            cp -v susfs4ksu/ksu_susfs/*.h KernelSU/kernel/ 2>/dev/null || true
          fi
          
          if [ -d "susfs4ksu/kernel_patches/ksu_susfs" ]; then
            cp -v susfs4ksu/kernel_patches/ksu_susfs/*.c KernelSU/kernel/ 2>/dev/null || true
            cp -v susfs4ksu/kernel_patches/ksu_susfs/*.h KernelSU/kernel/ 2>/dev/null || true
          fi
          
          find susfs4ksu -type f \( -name "*susfs*.c" -o -name "*susfs*.h" \) -exec cp -v {} KernelSU/kernel/ \; 2>/dev/null || true
          
          echo "‚úÖ SUSFS files copied!"
      
      - name: ‚ö° Create battery configs
        working-directory: kernel
        run: |
          mkdir -p arch/arm64/configs/vendor
          
          # Extreme Battery Config
          cat << 'CONFIG_EOF' > arch/arm64/configs/vendor/angelbeats_extreme_battery.config
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KPM=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_CPU_FREQ_GOV_POWERSAVE=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_CPU_IDLE=y
          CONFIG_CPU_IDLE_GOV_MENU=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_DEFAULT_BFQ=y
          CONFIG_PM=y
          CONFIG_PM_SLEEP=y
          CONFIG_PM_AUTOSLEEP=y
          CONFIG_PM_WAKELOCKS=y
          CONFIG_PM_WAKELOCKS_LIMIT=100
          CONFIG_PM_WAKELOCKS_GC=y
          CONFIG_NO_HZ_FULL=y
          CONFIG_NO_HZ_IDLE=y
          CONFIG_ZRAM=y
          CONFIG_ZRAM_WRITEBACK=y
          CONFIG_ZSMALLOC=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_LZ4_DECOMPRESS=y
          CONFIG_THERMAL=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_WIREGUARD=y
          CONFIG_EOF
          
          # Balanced Config
          cat << 'CONFIG_EOF' > arch/arm64/configs/vendor/angelbeats_balanced.config
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          CONFIG_KPM=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_GOV_POWERSAVE=y
          CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
          CONFIG_CPU_IDLE=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_DEFAULT_BFQ=y
          CONFIG_PM=y
          CONFIG_PM_SLEEP=y
          CONFIG_PM_WAKELOCKS=y
          CONFIG_PM_WAKELOCKS_LIMIT=200
          CONFIG_ZRAM=y
          CONFIG_ZSMALLOC=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_THERMAL=y
          CONFIG_THERMAL_GOV_STEP_WISE=y
          CONFIG_WIREGUARD=y
          CONFIG_EOF
          
          # Performance Config
          cat << 'CONFIG_EOF' > arch/arm64/configs/vendor/angelbeats_performance.config
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KPM=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_CPU_FREQ_GOV_PERFORMANCE=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_PM_WAKELOCKS_LIMIT=500
          CONFIG_ZRAM=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_THERMAL=y
          CONFIG_WIREGUARD=y
          CONFIG_EOF
          
          echo "‚úÖ Configs created!"
          ls -la arch/arm64/configs/vendor/angelbeats_*.config
      
      - name: üî® Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
      - name: üõ†Ô∏è Fix missing hwid Kconfig
        working-directory: kernel
        run: |
          mkdir -p drivers/misc/hwid
          touch drivers/misc/hwid/Kconfig
      - name: ‚öôÔ∏è Merge configs
        working-directory: kernel
        run: |
          BATTERY_CONFIG="angelbeats_balanced.config"
          
          case "${{ inputs.profile }}" in
            extreme_battery) BATTERY_CONFIG="angelbeats_extreme_battery.config" ;;
            balanced) BATTERY_CONFIG="angelbeats_balanced.config" ;;
            performance) BATTERY_CONFIG="angelbeats_performance.config" ;;
          esac
          
          cat arch/arm64/configs/gki_defconfig \
              arch/arm64/configs/vendor/shennong_GKI.config \
              arch/arm64/configs/vendor/$BATTERY_CONFIG \
              > .config
          
          echo "‚úÖ Configs merged!"
      
      - name: üèóÔ∏è Build kernel
        working-directory: kernel
        run: |
          export PATH="$GITHUB_WORKSPACE/clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1
          
          make olddefconfig
          make kernelversion
          make -j$(nproc) 2>&1 | tee ../build.log
          
          if [ -f arch/arm64/boot/Image.gz ]; then
            echo "‚úÖ Build successful!"
            ls -lh arch/arm64/boot/Image.gz
          else
            echo "‚ùå Build failed!"
            tail -100 ../build.log
            exit 1
          fi
      
      - name: üì¶ Package AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          cd AnyKernel3
          cp ../kernel/arch/arm64/boot/Image.gz ./
          
          cat << 'AKEOF' > anykernel.sh
          properties() { '
          kernel.string=AngelBeats-SukiSU-SUSFS-Xiaomi14Pro
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          do.cleanuponabort=0
          device.name1=shennong
          device.name2=Xiaomi 14 Pro
          device.name3=2311DRN47C
          supported.versions=14-15
          '; }
          block=/dev/block/by-name/boot;
          is_slot_device=auto;
          ramdisk_compression=auto;
          . tools/ak3-core.sh;
          dump_boot;
          write_boot;
          AKEOF
          
          PROFILE="${{ inputs.profile }}"
          DATE=$(date +%Y%m%d-%H%M)
          ZIPNAME="AngelBeats-SukiSU-Xiaomi14Pro-${PROFILE}-${DATE}.zip"
          
          zip -r9 "../${ZIPNAME}" * -x .git README.md *placeholder
          
          cd ..
          echo "ZIPNAME=${ZIPNAME}" >> $GITHUB_ENV
          
          cat << 'INFOEOF' > KERNEL_INFO.txt
          AngelBeats-Style Kernel for Xiaomi 14 Pro
          
          Features:
          - SukiSU Ultra root
          - SUSFS v2.0.0
          - KPM + KProbes
          - Battery optimization
          - BFQ I/O Scheduler
          
          Device: Xiaomi 14 Pro (shennong)
          Kernel: 6.1.118
          
          Flash via TWRP or Kernel Manager
          INFOEOF
      
      - name: üì§ Upload
        uses: actions/upload-artifact@v4
        with:
          name: Xiaomi-14-Pro-Kernel-${{ inputs.profile }}
          path: |
            *.zip
            KERNEL_INFO.txt
            build.log
      
      - name: üéâ Complete
        run: |
          echo "‚úÖ BUILD SUCCESSFUL!"
          echo "Kernel: ${{ env.ZIPNAME }}"
          echo "Profile: ${{ inputs.profile }}"
