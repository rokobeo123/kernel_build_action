name: üîã Xiaomi 14 Pro - SukiSU-SUSFS-AngelBeats-ULTIMATE

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Battery Profile'
        required: true
        default: 'balanced'
        type: choice
        options: [extreme_battery, balanced, performance]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Setup Tools & Source
        run: |
          sudo apt-get update && sudo apt-get install -y bc bison build-essential curl flex git gnupg gperf libssl-dev libxml2-utils lzop python3 zip zlib1g-dev
          git clone --depth=1 https://github.com/MiCode/Xiaomi_Kernel_OpenSource -b shennong-u-oss kernel
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          # Clone SUSFS Source for the 'dictionary' files
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1 susfs

      - name: ü©π Phase 1: Fix Xiaomi & Inject SUSFS Files
        working-directory: kernel
        run: |
          echo "üõ†Ô∏è Fixing Xiaomi header bugs..."
          sed -i '1i #include <linux/of_fdt.h>' arch/arm64/kernel/setup.c
          sed -i 's/cpu_coregroup_mask/cpu_cpu_mask/g' kernel/sched/topology.c
          
          echo "üìÇ Injecting SUSFS source files into dictionary..."
          cp -r ../susfs/kernel_patches/fs/* fs/
          cp -r ../susfs/kernel_patches/include/linux/* include/linux/

      - name: üöÄ Phase 2: Integrate SukiSU Hooks
        working-directory: kernel
        run: |
          # This script now finds the files we just injected and patches them
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin

      - name: ‚öôÔ∏è Phase 3: Merge Configs
        working-directory: kernel
        run: |
          export PATH="$GITHUB_WORKSPACE/clang/bin:$PATH"
          # Create Battery Fragment
          echo "CONFIG_KSU=y\nCONFIG_KSU_SUSFS=y\nCONFIG_KSU_SUSFS_SUS_PATH=y\nCONFIG_KSU_SUSFS_SUS_MOUNT=y" > arch/arm64/configs/vendor/angelbeats.config
          
          # Official Merge
          ARCH=arm64 ./scripts/kconfig/merge_config.sh -m -O . \
            arch/arm64/configs/gki_defconfig \
            arch/arm64/configs/vendor/shennong_GKI.config \
            arch/arm64/configs/vendor/angelbeats.config
          
          make ARCH=arm64 LLVM=1 LLVM_IAS=1 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig

      - name: üèóÔ∏è Phase 4: Compile
        working-directory: kernel
        run: |
          export PATH="$GITHUB_WORKSPACE/clang/bin:$PATH"
          make -j$(nproc) ARCH=arm64 LLVM=1 LLVM_IAS=1 \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            2>&1 | tee ../build.log

      - name: üì¶ Upload
        uses: actions/upload-artifact@v4
        with:
          name: Xiaomi-14-Pro-AngelBeats
          path: |
            kernel/arch/arm64/boot/Image.gz
            build.log
