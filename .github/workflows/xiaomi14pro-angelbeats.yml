name: üîã Xiaomi 14 Pro - AngelBeats Style + SukiSU + SUSFS

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Battery Profile'
        required: true
        default: 'balanced'
        type: choice
        options:
          - extreme_battery
          - balanced
          - performance

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üßπ Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
          df -h
      
      - name: üì¶ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf imagemagick \
            lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev \
            libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop \
            pngcrush rsync schedtool squashfs-tools xsltproc zip \
            zlib1g-dev python3 python-is-python3 wget cpio kmod libelf-dev \
            libssl-dev libncurses-dev
      
      - name: üìÇ Clone kernel source
        run: |
          git clone --depth=1 \
            https://github.com/MiCode/Xiaomi_Kernel_OpenSource \
            -b shennong-u-oss \
            kernel
          cd kernel
          git fetch --depth=1 origin shennong-s-oss 2>/dev/null || true
      
      - name: üîß Fix missing hwid driver
        working-directory: kernel
        run: |
          # Check if hwid directory exists
          if [ ! -d "drivers/misc/hwid" ]; then
            echo "‚ö†Ô∏è hwid directory missing, creating dummy Kconfig"
            mkdir -p drivers/misc/hwid
            
            # Create Kconfig
            cat << 'EOF' > drivers/misc/hwid/Kconfig
# Dummy hwid Kconfig
config HWID_DUMMY
    bool "Dummy HWID"
    default n
    help
        Dummy config for missing hwid driver
EOF
            
            # Create Makefile
            cat << 'EOF' > drivers/misc/hwid/Makefile
# Dummy hwid Makefile
# obj-$(CONFIG_HWID_DUMMY) += hwid.o
EOF
            
            echo "‚úÖ Created dummy hwid driver"
          else
            echo "‚úÖ hwid driver exists"
          fi
      
      - name: üîß Integrate SukiSU
        working-directory: kernel
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
          if [ -d "KernelSU" ]; then
            echo "‚úÖ SukiSU integrated!"
          else
            echo "‚ùå Failed to integrate SukiSU!"
            exit 1
          fi
      
      - name: üì• Clone SUSFS
        working-directory: kernel
        run: |
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1 susfs_source
          
          # Copy SUSFS files to KernelSU directory
          if [ -d "susfs_source/ksu_susfs" ]; then
            cp -rv susfs_source/ksu_susfs/* KernelSU/kernel/ 2>/dev/null || true
          fi
          
          if [ -d "susfs_source/kernel_patches/ksu_susfs" ]; then
            cp -rv susfs_source/kernel_patches/ksu_susfs/* KernelSU/kernel/ 2>/dev/null || true
          fi
          
          # Find and copy any susfs files
          find susfs_source -type f \( -name "*susfs*.c" -o -name "*susfs*.h" \) -exec cp -v {} KernelSU/kernel/ \; 2>/dev/null || true
          
          echo "‚úÖ SUSFS files copied!"
          ls -la KernelSU/kernel/*susfs* 2>/dev/null || echo "No susfs files found"
      
      - name: ‚ö° Create battery configs
        working-directory: kernel
        run: |
          mkdir -p arch/arm64/configs/vendor
          
          # Extreme Battery Config
          cat > arch/arm64/configs/vendor/angelbeats_extreme_battery.config << 'EOF'
# KernelSU
CONFIG_KSU=y
CONFIG_KSU_SUSFS=y
CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
CONFIG_KSU_SUSFS_SUS_PATH=y
CONFIG_KSU_SUSFS_SUS_MOUNT=y
CONFIG_KSU_SUSFS_SUS_KSTAT=y
CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
CONFIG_KSU_SUSFS_TRY_UMOUNT=y
CONFIG_KSU_SUSFS_SPOOF_UNAME=y
CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
CONFIG_KSU_SUSFS_ENABLE_LOG=y

# Kernel Modules
CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
CONFIG_MODULE_FORCE_UNLOAD=y

# Power Management
CONFIG_PM=y
CONFIG_PM_SLEEP=y
CONFIG_PM_AUTOSLEEP=y
CONFIG_PM_WAKELOCKS=y
CONFIG_PM_WAKELOCKS_LIMIT=100
CONFIG_PM_WAKELOCKS_GC=y

# CPU Frequency
CONFIG_CPU_FREQ=y
CONFIG_CPU_FREQ_DEFAULT_GOV_POWERSAVE=y
CONFIG_CPU_FREQ_GOV_POWERSAVE=y
CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
CONFIG_CPU_FREQ_GOV_PERFORMANCE=y

# CPU Idle
CONFIG_CPU_IDLE=y
CONFIG_CPU_IDLE_GOV_MENU=y

# I/O Scheduler
CONFIG_IOSCHED_BFQ=y
CONFIG_BFQ_GROUP_IOSCHED=y
CONFIG_MQ_IOSCHED_DEADLINE=y
CONFIG_MQ_IOSCHED_KYBER=y
CONFIG_IOSCHED_DEADLINE=y
CONFIG_IOSCHED_CFQ=y
CONFIG_DEFAULT_BFQ=y
CONFIG_DEFAULT_IOSCHED="bfq"

# Memory Management
CONFIG_ZRAM=y
CONFIG_ZRAM_WRITEBACK=y
CONFIG_ZSMALLOC=y
CONFIG_LZ4_COMPRESS=y
CONFIG_LZ4_DECOMPRESS=y

# Thermal
CONFIG_THERMAL=y
CONFIG_THERMAL_GOV_STEP_WISE=y
CONFIG_THERMAL_GOV_USER_SPACE=y
CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y

# Networking
CONFIG_WIREGUARD=y

# Debugging/Symbols
CONFIG_KALLSYMS=y
CONFIG_KALLSYMS_ALL=y
CONFIG_HAVE_KPROBES=y
CONFIG_KPROBES=y
CONFIG_KPROBE_EVENTS=y

# Tickless
CONFIG_NO_HZ_IDLE=y
CONFIG_NO_HZ_FULL=y
CONFIG_NO_HZ=y
CONFIG_HIGH_RES_TIMERS=y
EOF
          
          # Balanced Config
          cat > arch/arm64/configs/vendor/angelbeats_balanced.config << 'EOF'
# KernelSU
CONFIG_KSU=y
CONFIG_KSU_SUSFS=y
CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
CONFIG_KSU_SUSFS_SUS_PATH=y
CONFIG_KSU_SUSFS_SUS_MOUNT=y
CONFIG_KSU_SUSFS_SUS_KSTAT=y
CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
CONFIG_KSU_SUSFS_TRY_UMOUNT=y
CONFIG_KSU_SUSFS_SPOOF_UNAME=y
CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
CONFIG_KSU_SUSFS_ENABLE_LOG=y

# Kernel Modules
CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
CONFIG_MODULE_FORCE_UNLOAD=y

# Power Management
CONFIG_PM=y
CONFIG_PM_SLEEP=y
CONFIG_PM_AUTOSLEEP=y
CONFIG_PM_WAKELOCKS=y
CONFIG_PM_WAKELOCKS_LIMIT=200
CONFIG_PM_WAKELOCKS_GC=y

# CPU Frequency
CONFIG_CPU_FREQ=y
CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
CONFIG_CPU_FREQ_GOV_POWERSAVE=y
CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
CONFIG_CPU_FREQ_GOV_PERFORMANCE=y

# CPU Idle
CONFIG_CPU_IDLE=y
CONFIG_CPU_IDLE_GOV_MENU=y

# I/O Scheduler
CONFIG_IOSCHED_BFQ=y
CONFIG_BFQ_GROUP_IOSCHED=y
CONFIG_MQ_IOSCHED_DEADLINE=y
CONFIG_MQ_IOSCHED_KYBER=y
CONFIG_IOSCHED_DEADLINE=y
CONFIG_IOSCHED_CFQ=y
CONFIG_DEFAULT_BFQ=y
CONFIG_DEFAULT_IOSCHED="bfq"

# Memory Management
CONFIG_ZRAM=y
CONFIG_ZRAM_WRITEBACK=y
CONFIG_ZSMALLOC=y
CONFIG_LZ4_COMPRESS=y
CONFIG_LZ4_DECOMPRESS=y

# Thermal
CONFIG_THERMAL=y
CONFIG_THERMAL_GOV_STEP_WISE=y
CONFIG_THERMAL_GOV_USER_SPACE=y
CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y

# Networking
CONFIG_WIREGUARD=y

# Debugging/Symbols
CONFIG_KALLSYMS=y
CONFIG_KALLSYMS_ALL=y
CONFIG_HAVE_KPROBES=y
CONFIG_KPROBES=y
CONFIG_KPROBE_EVENTS=y

# Tickless
CONFIG_NO_HZ_IDLE=y
CONFIG_NO_HZ_FULL=y
CONFIG_NO_HZ=y
CONFIG_HIGH_RES_TIMERS=y
EOF
          
          # Performance Config
          cat > arch/arm64/configs/vendor/angelbeats_performance.config << 'EOF'
# KernelSU
CONFIG_KSU=y
CONFIG_KSU_SUSFS=y
CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
CONFIG_KSU_SUSFS_SUS_PATH=y
CONFIG_KSU_SUSFS_SUS_MOUNT=y
CONFIG_KSU_SUSFS_SUS_KSTAT=y
CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
CONFIG_KSU_SUSFS_TRY_UMOUNT=y
CONFIG_KSU_SUSFS_SPOOF_UNAME=y
CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
CONFIG_KSU_SUSFS_ENABLE_LOG=y

# Kernel Modules
CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
CONFIG_MODULE_FORCE_UNLOAD=y

# Power Management
CONFIG_PM=y
CONFIG_PM_SLEEP=y
CONFIG_PM_WAKELOCKS=y
CONFIG_PM_WAKELOCKS_LIMIT=500

# CPU Frequency
CONFIG_CPU_FREQ=y
CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE=y
CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
CONFIG_CPU_FREQ_GOV_PERFORMANCE=y

# CPU Idle
CONFIG_CPU_IDLE=y

# I/O Scheduler
CONFIG_IOSCHED_BFQ=y
CONFIG_BFQ_GROUP_IOSCHED=y
CONFIG_MQ_IOSCHED_DEADLINE=y
CONFIG_MQ_IOSCHED_KYBER=y
CONFIG_IOSCHED_DEADLINE=y
CONFIG_DEFAULT_BFQ=y
CONFIG_DEFAULT_IOSCHED="bfq"

# Memory Management
CONFIG_ZRAM=y
CONFIG_ZSMALLOC=y
CONFIG_LZ4_COMPRESS=y

# Thermal
CONFIG_THERMAL=y
CONFIG_THERMAL_GOV_POWER_ALLOCATOR=y

# Networking
CONFIG_WIREGUARD=y

# Debugging/Symbols
CONFIG_KALLSYMS=y
CONFIG_KALLSYMS_ALL=y
CONFIG_HAVE_KPROBES=y
CONFIG_KPROBES=y
CONFIG_KPROBE_EVENTS=y

# Tickless
CONFIG_NO_HZ_IDLE=y
CONFIG_HIGH_RES_TIMERS=y
EOF
          
          echo "‚úÖ Configs created!"
          ls -la arch/arm64/configs/vendor/angelbeats_*.config
      
      - name: üî® Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
      
      - name: ‚öôÔ∏è Merge configs and prepare build
        working-directory: kernel
        run: |
          # First, create a minimal working config
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- defconfig gki_defconfig
          
          # Apply vendor config if exists
          if [ -f "arch/arm64/configs/vendor/shennong_GKI.config" ]; then
            echo "Applying shennong_GKI.config"
            cat arch/arm64/configs/vendor/shennong_GKI.config >> .config
          fi
          
          # Apply battery profile config
          BATTERY_CONFIG="angelbeats_balanced.config"
          
          case "${{ inputs.profile }}" in
            extreme_battery) BATTERY_CONFIG="angelbeats_extreme_battery.config" ;;
            balanced) BATTERY_CONFIG="angelbeats_balanced.config" ;;
            performance) BATTERY_CONFIG="angelbeats_performance.config" ;;
          esac
          
          echo "Applying $BATTERY_CONFIG"
          cat arch/arm64/configs/vendor/$BATTERY_CONFIG >> .config
          
          # Update config
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
          
          echo "‚úÖ Config preparation complete!"
          echo "Checking KSU config..."
          grep -i ksu .config || echo "KSU not found in config"
      
      - name: üèóÔ∏è Build kernel
        working-directory: kernel
        run: |
          export PATH="$GITHUB_WORKSPACE/clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CC=clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          export LLVM=1
          export LLVM_IAS=1
          
          echo "üîß Build environment:"
          echo "CC: $(which clang)"
          echo "ARCH: $ARCH"
          
          # Show kernel version
          make kernelversion
          
          # Build with verbose output
          echo "üöÄ Starting build..."
          make -j$(nproc --all) 2>&1 | tee ../build.log
          
          if [ -f "arch/arm64/boot/Image.gz" ]; then
            echo "‚úÖ Build successful!"
            ls -lh arch/arm64/boot/Image.gz
            echo "Build size: $(du -h arch/arm64/boot/Image.gz | cut -f1)"
          else
            echo "‚ùå Build failed!"
            echo "=== Last 100 lines of build log ==="
            tail -100 ../build.log
            exit 1
          fi
      
      - name: üì¶ Package AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          cd AnyKernel3
          
          # Clean any existing files
          rm -f Image.gz dtb *.zip
          
          # Copy kernel image
          cp ../kernel/arch/arm64/boot/Image.gz ./
          
          # Check if image was copied
          if [ ! -f "Image.gz" ]; then
            echo "‚ùå Kernel image not found!"
            exit 1
          fi
          
          echo "‚úÖ Kernel image size: $(du -h Image.gz | cut -f1)"
          
          # Create anykernel.sh
          cat > anykernel.sh << 'EOF'
#!/bin/sh
# AnyKernel3 Ramdisk Mod Script
# osm0sis @ xda-developers

## AnyKernel setup
begin() {
  ui_print " "
  ui_print "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
  ui_print "‚ïë     AngelBeats Kernel for Xiaomi     ‚ïë"
  ui_print "‚ïë           14 Pro (shennong)          ‚ïë"
  ui_print "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
  ui_print " "
  ui_print "‚ä≥ Profile: $PROFILE"
  ui_print "‚ä≥ Features: SukiSU + SUSFS"
  ui_print " "
}

## AnyKernel properties
properties() {
  kernel.string=AngelBeats-SukiSU-SUSFS-Xiaomi14Pro
  do.devicecheck=1
  do.modules=0
  do.systemless=1
  do.cleanup=1
  do.cleanuponabort=0
  device.name1=shennong
  device.name2=2311DRN47C
  device.name3=Xiaomi 14 Pro
  supported.versions=14-15
  supported.patchlevels=
}

## AnyKernel install
block=/dev/block/by-name/boot;
is_slot_device=0;
ramdisk_compression=auto;

. tools/ak3-core.sh;

# Set profile
PROFILE="$PROFILE"

begin;
dump_boot;

ui_print "‚ä≥ Writing kernel...";
write_boot;

ui_print " ";
ui_print "‚úÖ AngelBeats Kernel installed successfully!";
ui_print " ";
EOF
          
          # Make script executable
          chmod +x anykernel.sh
          
          # Create zip
          PROFILE="${{ inputs.profile }}"
          DATE=$(date +%Y%m%d-%H%M)
          ZIPNAME="AngelBeats-Xiaomi14Pro-${PROFILE}-${DATE}.zip"
          
          zip -r9 "../${ZIPNAME}" * -x .git README.md .github/*
          
          cd ..
          echo "ZIPNAME=${ZIPNAME}" >> $GITHUB_ENV
          
          # Create info file
          cat > KERNEL_INFO.txt << 'EOF'
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   AngelBeats Kernel for Xiaomi 14 Pro       ‚îÇ
‚îÇ           (shennong/2311DRN47C)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

üìã Features:
‚Ä¢ SukiSU Ultra Root Support
‚Ä¢ SUSFS v2.0.0 (Systemless Overlay)
‚Ä¢ KernelSU Integration
‚Ä¢ Battery Optimization Profiles
‚Ä¢ BFQ I/O Scheduler
‚Ä¢ WireGuard VPN
‚Ä¢ ZRAM Compression

‚ö° Profiles:
‚Ä¢ Extreme Battery: Maximum power saving
‚Ä¢ Balanced: Balanced performance/battery
‚Ä¢ Performance: Maximum performance

üì± Device: Xiaomi 14 Pro (shennong)
üîß Kernel: 6.1.x
üì¶ Profile: ${{ inputs.profile }}

‚ö†Ô∏è  Installation:
1. Backup current kernel/boot
2. Flash in TWRP or KernelFlasher
3. Reboot and enjoy!

üêõ Report issues:
‚Ä¢ Include full logcat
‚Ä¢ Mention profile used
‚Ä¢ Device state before flash
EOF
      
      - name: üì§ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AngelBeats-Xiaomi14Pro-${{ inputs.profile }}
          path: |
            ${{ env.ZIPNAME }}
            KERNEL_INFO.txt
            build.log
          retention-days: 7
      
      - name: üéâ Build Complete
        run: |
          echo "========================================"
          echo "‚úÖ BUILD SUCCESSFUL!"
          echo "========================================"
          echo "Kernel: ${{ env.ZIPNAME }}"
          echo "Profile: ${{ inputs.profile }}"
          echo "Date: $(date)"
          echo "========================================"
