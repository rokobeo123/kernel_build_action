name: ðŸ”‹ Xiaomi 14 Pro - AngelBeats + SukiSU + SUSFS

on:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Battery Profile'
        required: true
        default: 'balanced'
        type: choice
        options:
          - extreme_battery
          - balanced
          - performance
  
  push:
    branches:
      - main
    paths:
      - '.github/workflows/xiaomi14pro-angelbeats.yml'

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-22.04
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: Set profile
        run: |
          if [ -z "${{ inputs.profile }}" ]; then
            echo "PROFILE=balanced" >> $GITHUB_ENV
          else
            echo "PROFILE=${{ inputs.profile }}" >> $GITHUB_ENV
          fi
      
      - name: ðŸ§¹ Free space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo apt-get clean
      
      - name: ðŸ“¦ Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git gnupg gperf imagemagick \
            lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev \
            libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop \
            pngcrush rsync schedtool squashfs-tools xsltproc zip \
            zlib1g-dev python3 python-is-python3 wget cpio kmod \
            libelf-dev libelf1 elfutils
      
      - name: ðŸ“‚ Clone kernel
        run: |
          git clone --depth=1 \
            https://github.com/MiCode/Xiaomi_Kernel_OpenSource \
            -b shennong-u-oss \
            kernel
          cd kernel
          make kernelversion 2>/dev/null || cat Makefile | head -5
      
      - name: ðŸ”§ Fix Kconfig
        working-directory: kernel
        run: |
          if [ -f "drivers/misc/Kconfig" ]; then
            sed -i '/source "drivers\/misc\/hwid\/Kconfig"/d' drivers/misc/Kconfig
          fi
      
      - name: ðŸ”§ Remove debug_kinfo
        working-directory: kernel
        run: |
          rm -f drivers/android/debug_kinfo.c
          if [ -f "drivers/android/Makefile" ]; then
            sed -i '/debug_kinfo/d' drivers/android/Makefile
          fi
      
      - name: ðŸ”§ Integrate SukiSU
        working-directory: kernel
        run: |
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
          [ -d "KernelSU" ] || exit 1
      
      - name: ðŸ“¥ Clone SUSFS and integrate
        working-directory: kernel
        run: |
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android14-6.1
          
          cd susfs4ksu/kernel_patches
          
          cp -v fs/susfs.c ../../fs/
          mkdir -p ../../include/linux
          cp -v include/linux/susfs_def.h ../../include/linux/
          cp -v include/linux/susfs.h ../../include/linux/
          
          cd ../..
          
          # Add to Makefile
          if ! grep -q "susfs.o" fs/Makefile; then
            echo "obj-\$(CONFIG_KSU_SUSFS) += susfs.o" >> fs/Makefile
          fi
      
      - name: âš¡ Create configs
        working-directory: kernel
        run: |
          mkdir -p arch/arm64/configs/vendor
          
          cat > arch/arm64/configs/vendor/angelbeats_extreme_battery.config << 'END'
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          # CONFIG_KSU_SUSFS_SUS_KLOG is not set
          CONFIG_KPM=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_CPU_FREQ_GOV_POWERSAVE=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_PM_WAKELOCKS_LIMIT=100
          CONFIG_ZRAM=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_WIREGUARD=y
          CONFIG_TMPFS_XATTR=y
          END
          
          cat > arch/arm64/configs/vendor/angelbeats_balanced.config << 'END'
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          CONFIG_KSU_SUSFS_ENABLE_LOG=y
          # CONFIG_KSU_SUSFS_SUS_KLOG is not set
          CONFIG_KPM=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_CPU_FREQ_DEFAULT_GOV_SCHEDUTIL=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_PM_WAKELOCKS_LIMIT=200
          CONFIG_ZRAM=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_WIREGUARD=y
          CONFIG_TMPFS_XATTR=y
          END
          
          cat > arch/arm64/configs/vendor/angelbeats_performance.config << 'END'
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_OPEN_REDIRECT=y
          CONFIG_KSU_SUSFS_SUS_PATH=y
          CONFIG_KSU_SUSFS_SUS_MOUNT=y
          CONFIG_KSU_SUSFS_SUS_KSTAT=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=y
          CONFIG_KSU_SUSFS_TRY_UMOUNT=y
          CONFIG_KSU_SUSFS_SPOOF_UNAME=y
          CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT=y
          # CONFIG_KSU_SUSFS_SUS_KLOG is not set
          CONFIG_KPM=y
          CONFIG_KPROBES=y
          CONFIG_HAVE_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_CPU_FREQ_GOV_SCHEDUTIL=y
          CONFIG_IOSCHED_BFQ=y
          CONFIG_BFQ_GROUP_IOSCHED=y
          CONFIG_PM_WAKELOCKS_LIMIT=500
          CONFIG_ZRAM=y
          CONFIG_LZ4_COMPRESS=y
          CONFIG_WIREGUARD=y
          CONFIG_TMPFS_XATTR=y
          END
      
      - name: ðŸ”¨ Clone Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
      
      - name: âš™ï¸ Merge configs
        working-directory: kernel
        run: |
          BATTERY_CONFIG="angelbeats_${PROFILE}.config"
          cat arch/arm64/configs/gki_defconfig \
              arch/arm64/configs/vendor/shennong_GKI.config \
              arch/arm64/configs/vendor/$BATTERY_CONFIG \
              > .config
      
      - name: ðŸ› ï¸ Fix ALL issues
        working-directory: kernel
        run: |
          echo "Applying all fixes..."
          
          scripts/config --disable CONFIG_WERROR
          scripts/config --disable CONFIG_CC_WERROR
          scripts/config --disable CONFIG_SCHED_CLUSTER
          scripts/config --enable CONFIG_OF
          scripts/config --enable CONFIG_OF_EARLY_FLATTREE
          scripts/config --enable CONFIG_OF_FLATTREE
          scripts/config --enable CONFIG_MODULES
          scripts/config --disable CONFIG_DEBUG_KINFO
          scripts/config --disable CONFIG_DEBUG_INFO_BTF
          scripts/config --disable CONFIG_DEBUG_INFO
          scripts/config --enable CONFIG_TMPFS_XATTR
          
          # Keep pkvm and gunyah enabled (they need CONFIG_MODULES)
          scripts/config --enable CONFIG_PKVM
          scripts/config --enable CONFIG_GUNYAH
          
          # Disable module signing to avoid signature issues
          scripts/config --disable CONFIG_MODULE_SIG
          scripts/config --disable CONFIG_MODULE_SIG_ALL
          scripts/config --disable CONFIG_MODULE_SIG_FORCE
          scripts/config --disable CONFIG_SECURITY_LOADPIN
          
          # Force SUSFS to be built-in (=y not =m)
          scripts/config --enable CONFIG_KSU_SUSFS
          scripts/config --enable CONFIG_KSU_SUSFS_SUS_SU
          scripts/config --enable CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
          scripts/config --enable CONFIG_KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
          scripts/config --enable CONFIG_KSU_SUSFS_AUTO_ADD_SUS_KSU_HIDE_ZYGISK
          scripts/config --disable CONFIG_KSU_SUSFS_SUS_KLOG
          scripts/config --enable CONFIG_KSU_SUSFS_OPEN_REDIRECT
          scripts/config --enable CONFIG_KSU_SUSFS_SUS_PATH
          scripts/config --enable CONFIG_KSU_SUSFS_SUS_MOUNT
          scripts/config --enable CONFIG_KSU_SUSFS_SUS_KSTAT
          scripts/config --enable CONFIG_KSU_SUSFS_SUS_OVERLAYFS
          scripts/config --enable CONFIG_KSU_SUSFS_TRY_UMOUNT
          scripts/config --enable CONFIG_KSU_SUSFS_SPOOF_UNAME
          scripts/config --enable CONFIG_KSU_SUSFS_HAS_MAGIC_MOUNT
          scripts/config --enable CONFIG_KSU_SUSFS_ENABLE_LOG
          
          echo "âœ… All fixes applied!"
          
          echo ""
          echo "=== Verifying config ==="
          grep "CONFIG_KSU" .config | grep -v "^#"
      
      - name: ðŸ”§ Patch SUSFS missing functions
        working-directory: kernel
        run: |
          echo "=== Understanding the SUSFS code structure ==="
          
          echo "Step 1: Check what config guards susfs_is_avc_log_spoofing_enabled"
          grep -B5 -A5 "susfs_is_avc_log_spoofing_enabled" fs/susfs.c | head -40
          
          echo ""
          echo "Step 2: Check all #ifdef in susfs.c"
          grep "#ifdef\|#ifndef\|#if defined" fs/susfs.c | head -30
          
          echo ""
          echo "Step 3: Who's calling these symbols?"
          grep -r "susfs_is_avc_log_spoofing_enabled\|susfs_reorder_mnt_id" --include="*.c" drivers/ 2>/dev/null | head -10
          
          echo ""
          echo "=== The Fix: Make symbols unconditionally available ==="
          
          # Approach: Remove ALL #ifdef guards around these symbols to make them always available
          
          # Create a Python script to do sophisticated patching
          cat > /tmp/patch_susfs.py << 'PYSCRIPT'
          import re
          import sys
          
          with open('fs/susfs.c', 'r') as f:
              content = f.read()
          
          # Find and remove #ifdef guards around susfs_is_avc_log_spoofing_enabled
          # Pattern: #ifdef CONFIG_xxx ... bool susfs_is_avc_log_spoofing_enabled = false; ... #endif
          
          # Method 1: Just make sure the variable is not static
          content = re.sub(r'^static bool susfs_is_avc_log_spoofing_enabled', 
                          'bool susfs_is_avc_log_spoofing_enabled', 
                          content, flags=re.MULTILINE)
          
          # Method 2: Add EXPORT_SYMBOL if not present
          if 'EXPORT_SYMBOL_GPL(susfs_is_avc_log_spoofing_enabled)' not in content:
              # Find the variable declaration and add export after it
              content = re.sub(r'(bool susfs_is_avc_log_spoofing_enabled.*?;)',
                              r'\1\nEXPORT_SYMBOL_GPL(susfs_is_avc_log_spoofing_enabled);',
                              content, count=1)
          
          # Method 3: Add susfs_reorder_mnt_id if missing
          if 'void susfs_reorder_mnt_id' not in content:
              content += '''
          
          void susfs_reorder_mnt_id(void)
          {
              /* Stub */
          }
          EXPORT_SYMBOL_GPL(susfs_reorder_mnt_id);
          '''
          
          with open('fs/susfs.c', 'w') as f:
              f.write(content)
          
          print("âœ… Patching complete")
          PYSCRIPT
          
          python3 /tmp/patch_susfs.py
          
          echo ""
          echo "=== Update header file ==="
          if [ -f "include/linux/susfs.h" ]; then
            # Remove old declarations
            sed -i '/extern bool susfs_is_avc_log_spoofing_enabled/d' include/linux/susfs.h
            sed -i '/void susfs_reorder_mnt_id/d' include/linux/susfs.h
            
            # Add at the end before final #endif
            LAST_LINE=$(wc -l < include/linux/susfs.h)
            sed -i "${LAST_LINE}i\\
          extern bool susfs_is_avc_log_spoofing_enabled;\\
          void susfs_reorder_mnt_id(void);\\
          " include/linux/susfs.h
          fi
          
          echo ""
          echo "=== Verification ==="
          echo "Variable declaration:"
          grep -n "bool susfs_is_avc_log_spoofing_enabled" fs/susfs.c | head -3
          
          echo ""
          echo "EXPORT_SYMBOL:"
          grep -n "EXPORT_SYMBOL.*susfs_is_avc\|EXPORT_SYMBOL.*susfs_reorder" fs/susfs.c
          
          echo ""
          echo "Functions:"
          grep -A2 "void susfs_reorder_mnt_id" fs/susfs.c
          
          echo ""
          echo "âœ… SUSFS patching complete!"
      
      - name: ðŸ”§ Patch PKVM if needed
        working-directory: kernel
        run: |
          if [ -f "arch/arm64/kvm/pkvm.c" ]; then
            echo "Checking PKVM..."
            
            if ! grep -q "pkvm_load_early_modules" arch/arm64/kvm/pkvm.c; then
              echo "Adding pkvm_load_early_modules stub..."
              cat >> arch/arm64/kvm/pkvm.c << 'PKVM_PATCH'
          
          #ifdef CONFIG_MODULES
          int pkvm_load_early_modules(void) {
              return 0;
          }
          #endif
          PKVM_PATCH
              echo "âœ… PKVM stub added!"
            else
              echo "âœ… PKVM already has the function"
            fi
          fi
      
      - name: ðŸ—ï¸ Build
        working-directory: kernel
        run: |
          export PATH="$GITHUB_WORKSPACE/clang/bin:$PATH"
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1
          
          clang --version | head -1
          make kernelversion
          
          echo ""
          echo "=== Running olddefconfig ==="
          make olddefconfig 2>&1 | tee ../olddefconfig.log
          
          echo ""
          echo "=== Final .config check ==="
          echo "KSU configs:"
          grep "^CONFIG_KSU" .config | head -20
          echo ""
          echo "SUSFS status:"
          grep "^CONFIG_KSU_SUSFS" .config || echo "âŒ CONFIG_KSU_SUSFS not found!"
          
          echo ""
          echo "=== Checking Makefile ==="
          echo "fs/Makefile SUSFS entries:"
          grep susfs fs/Makefile || echo "âŒ No SUSFS in fs/Makefile!"
          
          echo ""
          echo "=== First, try building susfs.o specifically ==="
          make fs/susfs.o 2>&1 | tee ../susfs_build.log || true
          
          if [ -f fs/susfs.o ]; then
            echo "âœ… susfs.o was built successfully!"
            echo "Checking symbols in susfs.o:"
            nm fs/susfs.o | grep -i susfs_is_avc || echo "Symbol not found in object file"
            nm fs/susfs.o | grep -i susfs_reorder || echo "Reorder symbol not found"
            echo ""
            echo "All exported symbols in susfs.o:"
            nm fs/susfs.o | grep " T \| D \| R " | head -20
          else
            echo "âŒ Failed to build susfs.o"
            echo "Build errors:"
            tail -50 ../susfs_build.log
          fi
          
          echo ""
          echo "=== Starting full kernel build ==="
          make -j$(nproc) \
            KCFLAGS="-Wno-error -Wno-implicit-function-declaration -Wno-sometimes-uninitialized" \
            2>&1 | tee ../build.log
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          # Check if Image.gz was created
          if [ -f arch/arm64/boot/Image.gz ]; then
            echo ""
            echo "âœ… BUILD SUCCESS!"
            ls -lh arch/arm64/boot/Image.gz
            exit 0
          fi
          
          # If build failed, provide detailed diagnostics
          echo ""
          echo "âŒ BUILD FAILED!"
          
          echo ""
          echo "=== Checking vmlinux for symbols ==="
          if [ -f vmlinux ]; then
            nm vmlinux | grep -i susfs_is_avc || echo "Symbol not in vmlinux"
            nm vmlinux | grep -i susfs_reorder || echo "Reorder not in vmlinux"
          fi
          
          echo ""
          echo "=== Last 200 lines of build log ==="
          tail -200 ../build.log
          
          echo ""
          echo "=== All linker errors ==="
          grep "ld.lld: error" ../build.log || true
          
          exit 1
      
      - name: ðŸ“¦ Package
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          cd AnyKernel3
          cp ../kernel/arch/arm64/boot/Image.gz ./
          
          cat > anykernel.sh << 'AK'
          properties() { '
          kernel.string=AngelBeats-SukiSU-Xiaomi14Pro
          do.devicecheck=1
          do.modules=0
          do.systemless=1
          do.cleanup=1
          device.name1=shennong
          device.name2=Xiaomi 14 Pro
          supported.versions=14-15
          '; }
          block=/dev/block/by-name/boot;
          is_slot_device=auto;
          ramdisk_compression=auto;
          . tools/ak3-core.sh;
          dump_boot;
          write_boot;
          AK
          
          DATE=$(date +%Y%m%d-%H%M)
          ZIPNAME="AngelBeats-SukiSU-Xiaomi14Pro-${PROFILE}-${DATE}.zip"
          zip -r9 "../${ZIPNAME}" * -x .git README.md *placeholder
          cd ..
          echo "ZIPNAME=${ZIPNAME}" >> $GITHUB_ENV
      
      - name: ðŸ“¤ Upload
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-${{ env.PROFILE }}
          path: |
            *.zip
            build.log
      
      - name: ðŸŽ‰ Done
        run: |
          echo "âœ… ${{ env.ZIPNAME }}"
